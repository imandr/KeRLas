<html>

<head>
    <script src="/static/request.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script>
        google.charts.load('current', {packages: ['corechart', 'line']});
    </script>
</head>

<body>
    <p id="message"></p>
    <div id="charts"></div>
    <div id="chart_div" style="width: 900px; height: 500px;"></div>

    <script>
        var charts = {};                // id -> chart object
        var options = {
                interpolateNulls: true
        }
        
        chart = new google.visualization.LineChart(document.getElementById('chart_div'));

        var receiver = {
            data_received: function (data, c)
            {
                var labels = data.labels;
                var rows = data.data;
                var desc = data.plot_desc;
                var plots = [];
                
                desc.forEach( (subplot_desc, i) = > {
                        var series = [];
                        Object.entries(subplot_desc).forEach(([label, options]) => {
                                var series_options = {};
                                if( "line_width" in options )
                                        series_options.lineWidth = options.line_width;
                                if( "color" in attrs )
                                        series_options.color = options.color;
                                if( "marker_style" in options )
                                {
                                        series_options.pointShape = options.marker_style;
                                        series_options.pointVisible = true;
                                }
                                else
                                        series_options.pointVisible = false;
                                series.push({
                                        "label": label,
                                        "options": series_options
                                });
                        }
                        plots.push(series);
                });
                
                if( rows.length > 0 && labels.length > 0 )
                {
                        var data_table = new google.visualization.DataTable();
                        var i;
                        for( i = 0; i < labels.length; i++ )
                            data_table.addColumn("number", labels[i]);
                
                        data_table.addRows(rows);
                        c.draw(data_table, options);
                        document.getElementById("message").innerHTML = "";
                }
                else
                {
                        document.getElementById("message").innerHTML = "No data received";
                }
                
            }
        };
        
        function request_data()
        {
            var request = HTTPRequest("/data", receiver, chart, "json");            
        }

        function init_chart()
        {
            request_data();
            setInterval(request_data, 5000);
        }
        
        google.charts.setOnLoadCallback(init_chart);
        
        
        
    </script>
</body>

</html>
